<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}">
    <title>Backgammon Dashboard</title>
</head>
<body>
<div class="dashboard-wrapper"
     th:attr="data-current-email=${currentUserEmail}, data-current-username=${userName}, data-current-id=${currentUserId}">
    <header class="dashboard-header">
        <h1>Welcome <span th:text="${userName}">Player</span>,</h1>
        <nav class="dashboard-actions">
            <a class="action-link" th:href="@{/profile}">Profile</a>
            <a class="action-link" href="#" onclick="document.getElementById('logoutForm').submit(); return false;">Log Out</a>
        </nav>
    </header>

    <main class="dashboard-content">
        <section class="panel profile-panel">
            <h2>Profile</h2>
            <p>Review your stats, update your info, and see past games in your profile.</p>
            <a class="button-link" th:href="@{/profile}">Go to Profile</a>
        </section>

        <section class="panel users-panel">
            <div class="panel-header">
                <h2>Users Online</h2>
            </div>
            <ul class="user-list">
                <li th:if="${#lists.isEmpty(onlineUsers)}" class="user-card empty">No players online right now.</li>
                <li th:each="onlineUser : ${onlineUsers}"
                    class="user-card"
                    th:classappend="${onlineUser.inGame} ? ' in-game' : ' available'"
                    th:data-username="${onlineUser.username}"
                    th:data-email="${onlineUser.email}"
                    th:data-userid="${onlineUser.userId}"
                    th:data-status="${onlineUser.inGame} ? 'IN_GAME' : 'FREE'">
                    <div class="user-card__content">
                        <div>
                            <span class="user-card__name" th:text="${onlineUser.username}">Opponent</span>
                            <span class="status-badge"
                                  th:text="${onlineUser.inGame} ? 'In a game' : 'Free'"
                                  th:classappend="${onlineUser.inGame} ? ' status-badge--busy' : ' status-badge--free'">
                                Free
                            </span>
                        </div>
                        <button type="button"
                                class="invite-button"
                                th:disabled="${onlineUser.inGame}"
                                th:title="${onlineUser.inGame} ? 'Player is currently in a game' : 'Invite to game'">
                            Invite to game
                        </button>
                    </div>
                </li>
            </ul>
        </section>
    </main>
</div>

<form id="logoutForm" th:action="@{/logout}" method="post" style="display:none">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
</form>

<!-- Outgoing invitation modal -->
<div id="outgoingInviteModal" class="modal-backdrop" th:classappend="${outgoingInvitation} != null ? ' is-visible'">
    <div class="modal">
        <h3 th:text="'Waiting for ' + ${outgoingInvitation?.username} + ' to accept the invitation.'">
            Waiting for Player to accept the invitation.
        </h3>
        <button type="button" class="button-link" onclick="window.dashboard.closeOutgoingModal()">Close</button>
    </div>
</div>

<!-- Incoming invitation modal -->
<div id="incomingInviteModal" class="modal-backdrop" th:classappend="${incomingInvitation} != null ? ' is-visible'">
    <div class="modal">
        <h3 th:text="${incomingInvitation?.username} + ' has invited you to join a game.'">
            Player has invited you to join a game.
        </h3>
        <div class="modal-actions">
            <form th:action="@{/invitations/accept}" method="post">
                <input type="hidden" name="inviter" value="">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="button-link">Accept</button>
            </form>
            <form th:action="@{/invitations/decline}" method="post">
                <input type="hidden" name="inviter" value="">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="button-link button-link--ghost">Decline</button>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script th:inline="javascript">
/*<![CDATA[*/
    window.dashboard = window.dashboard || {};
    (function () {
        var dashboard = window.dashboard;
        dashboard.outgoingModal = null;
        dashboard.incomingModal = null;
        dashboard.stompClient = null;
        dashboard.currentUserEmail = null;
        dashboard.currentUserName = null;
        dashboard.currentUserId = null;

        dashboard.init = function () {
            var root = document.querySelector('.dashboard-wrapper');
            if (root) {
                dashboard.currentUserEmail = root.dataset.currentEmail || null;
                dashboard.currentUserName = root.dataset.currentUsername || '';
                if (root.dataset.currentId) {
                    var parsedId = parseInt(root.dataset.currentId, 10);
                    dashboard.currentUserId = Number.isNaN(parsedId) ? null : parsedId;
                } else {
                    dashboard.currentUserId = null;
                }
            }
            dashboard.outgoingModal = document.getElementById('outgoingInviteModal');
            dashboard.incomingModal = document.getElementById('incomingInviteModal');

            connectWebSocket();
            attachInviteHandlers();
        };

        function connectWebSocket() {
            if (typeof SockJS === 'undefined' || typeof Stomp === 'undefined') {
                console.error('SockJS/STOMP libraries are missing.');
                return;
            }
            var endpoint = /*[[@{/ws}]]*/ '/ws';
            var socket = new SockJS(endpoint);
            dashboard.stompClient = Stomp.over(socket);
            dashboard.stompClient.connect({}, function () {
                var destination = invitationDestination(dashboard.currentUserEmail);
                if (!destination) {
                    console.warn('No email available for subscription; invite updates disabled.');
                    return;
                }
                dashboard.stompClient.subscribe(destination, function (message) {
                    try {
                        var invite = JSON.parse(message.body);
                        handleInviteNotification(invite);
                    } catch (error) {
                        console.error('Failed to process invite message', error);
                    }
                });
            }, function (error) {
                console.error('STOMP connection error', error);
            });
        }

        function attachInviteHandlers() {
            var inviteButtons = document.querySelectorAll('.user-card.available .invite-button');
            inviteButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    var card = button.closest('.user-card');
                    var inviteeEmail = card ? card.dataset.email : null;
                    var inviteeUsername = card ? card.dataset.username : null;
                    var inviteeUserId = null;
                    if (card && card.dataset.userid) {
                        var parsedInviteeId = parseInt(card.dataset.userid, 10);
                        inviteeUserId = Number.isNaN(parsedInviteeId) ? null : parsedInviteeId;
                    }

                    if (!dashboard.stompClient || !dashboard.stompClient.connected) {
                        console.warn('WebSocket connection is not ready; invitation not sent.');
                        return;
                    }
                    if (!dashboard.currentUserEmail || !inviteeEmail) {
                        console.warn('Missing inviter or invitee information; invitation not sent.');
                        return;
                    }

                    var payload = {
                        gameId: null,
                        inviterUserId: dashboard.currentUserId,
                        inviteeUserId: inviteeUserId,
                        inviterEmail: dashboard.currentUserEmail,
                        inviteeEmail: inviteeEmail,
                        inviterUsername: dashboard.currentUserName || 'You',
                        inviteeUsername: inviteeUsername,
                        status: 'SENT',
                        timestamp: new Date().toISOString()
                    };

                    dashboard.stompClient.send('/app/invite.send', {}, JSON.stringify(payload));
                    showWaitingModal(inviteeUsername);
                });
            });
        }

        function invitationDestination(email) {
            if (!email) {
                return null;
            }
            return '/topic/invites/' + email;
        }

        function showWaitingModal(targetUsername) {
            if (!dashboard.outgoingModal) return;
            var heading = dashboard.outgoingModal.querySelector('h3');
            if (heading) {
                heading.textContent = 'Waiting for ' + targetUsername + ' to accept the invitation.';
            }
            dashboard.outgoingModal.classList.add('is-visible');
        }

        dashboard.closeOutgoingModal = function () {
            if (dashboard.outgoingModal) {
                dashboard.outgoingModal.classList.remove('is-visible');
            }
        };

        function handleInviteNotification(invite) {
            if (!invite || !dashboard.currentUserEmail) {
                return;
            }

            var currentEmail = dashboard.currentUserEmail.toLowerCase();
            if (invite.inviteeEmail && invite.inviteeEmail.toLowerCase() === currentEmail) {
                handleIncomingInvite(invite);
            } else if (invite.inviterEmail && invite.inviterEmail.toLowerCase() === currentEmail) {
                handleOutgoingUpdate(invite);
            }
        }

        function handleIncomingInvite(invite) {
            if (!dashboard.incomingModal) return;
            var header = dashboard.incomingModal.querySelector('h3');
            var hiddenInputs = dashboard.incomingModal.querySelectorAll('input[name="inviter"]');

            if (invite.status === 'SENT') {
                if (header) {
                    header.textContent = invite.inviterUsername + ' has invited you to join a game.';
                }
                hiddenInputs.forEach(function (input) {
                    input.value = invite.inviterEmail;
                });
                dashboard.incomingModal.classList.add('is-visible');
            } else if (invite.status === 'DECLINED' || invite.status === 'CANCELLED' || invite.status === 'EXPIRED') {
                dashboard.incomingModal.classList.remove('is-visible');
            } else if (invite.status === 'ACCEPTED') {
                redirectToGame(invite.gameId);
            }
        }

        function handleOutgoingUpdate(invite) {
            if (!dashboard.outgoingModal) return;
            var header = dashboard.outgoingModal.querySelector('h3');

            if (invite.status === 'DECLINED') {
                if (header) {
                    header.textContent = invite.inviteeUsername + ' declined the invitation.';
                }
                dashboard.outgoingModal.classList.add('is-visible');
            } else if (invite.status === 'ACCEPTED') {
                redirectToGame(invite.gameId);
            } else if (invite.status === 'CANCELLED' || invite.status === 'EXPIRED') {
                dashboard.outgoingModal.classList.remove('is-visible');
            }
        }

        function redirectToGame(gameId) {
            if (gameId) {
                window.location.href = '/game?gameId=' + gameId;
            } else {
                window.location.href = '/game';
            }
        }

        document.addEventListener('DOMContentLoaded', dashboard.init);
    })();
/*]]>*/
</script>
</body>
</html>
